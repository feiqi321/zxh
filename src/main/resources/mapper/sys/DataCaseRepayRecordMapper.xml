<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xyz.zaijushou.zhx.sys.dao.DataCaseRepayRecordMapper">

    <sql id="colSql">
        r.id as id,
        r.data_case as [dataCase.id],
        c.collect_status as [dataCase.collectStatus],
        c.batch_no as [dataCase.batchNo],
        c.client as [dataCase.client],
        c.seq_no as [dataCase.seqNo],
        c.ident_no as [dataCase.identNo],
        c.card_no as [dataCase.cardNo],
        c.card_type as [dataCase.cardType],
        c.account as [dataCase.account],
        c.currency_type as [dataCase.currencyType],
        c.archive_no as [dataCase.archiveNo],
        c.name as [dataCase.name],
        c.money as [dataCase.money],
        c.balance as [dataCase.balance],
        c.en_repay_amt as [dataCase.enRepayAmt],
        c.account_age as [dataCase.overdueBillTime],
        c.principle as [dataCase.principle],
        c.last_repay_date as [dataCase.lastRepayDate],
        dbo.fnFormatDate(c.case_date, 'yyyy-MM-dd') as [dataCase.caseDate],
        c.odv as [dataCase.collectionUser.id],
        c.credit_line as [dataCase.creditLine],
        c.home_address as [dataCase.homeAddress],
        c.home_tel_number as [dataCase.homeTelNumber],
        c.unit_name as [dataCase.unitName],
        c.unit_address as [dataCase.unitAddress],
        c.tel as [dataCase.tel],
        c.unit_tel_number as [dataCase.unitTelNumber],
        c.m_val as [dataCase.mVal],
        c.commission_money as [dataCase.commissionMoney],
        r.collect_user as [collectUser.id],
        r.repay_date as repayDate,
        r.repay_money as repayMoney,
        r.repay_user as repayUser,
        r.repay_type as [repayType.id],
        r.confirm_user as [confirmUser.id],
        r.confirm_time as confirmTime,
        r.record_status as recordStatus,
        r.remark as remark,
        r.create_user as [createUser.id],
        r.update_user as [updateUser.id],
        r.create_time as createTime,
        r.update_time as updateTime,
        r.delete_flag as deleteFlag
    </sql>

    <select id="pageRepayRecordList" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        <include refid="colSql"/>
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.id != null">
            and r.collect_user = #{dataCase.collectionUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.name != null">
            and c.province = #{dataCase.province.name}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.name != null">
            and c.city = #{dataCase.city.name}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.name != null">
            and c.county = #{dataCase.county.name}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_time >= #{dataCase.expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_time &lt;= #{dataCase.expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date &lt;= #{repayDateEnd}
        </if>

        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.ids != null
                and dataCase.collectionArea.ids.length > 0">
            and c.collection_area in
            <foreach item="item" index="index" collection="dataCase.collectionArea.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.batchNos != null
                and dataCase.batchNos.length > 0">
            and c.batch_no in
            <foreach item="item" index="index" collection="dataCase.batchNos" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.clients != null
                and dataCase.clients.length > 0">
            and c.client in
            <foreach item="item" index="index" collection="dataCase.clients" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.ids != null
                and dataCase.collectionUser.ids.length > 0">
            and r.collect_user in
            <foreach item="item" index="index" collection="dataCase.collectionUser.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.statuss != null
                and dataCase.statuss.length > 0">
            and c.status in
            <foreach item="item" index="index" collection="dataCase.statuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.accountAges != null
                and dataCase.accountAges.length > 0">
            and c.account_age in
            <foreach item="item" index="index" collection="dataCase.accountAges" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectStatuss != null
                and dataCase.collectStatuss.length > 0">
            and c.collect_status in
            <foreach item="item" index="index" collection="dataCase.collectStatuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>


        <if test="dataCase != null and dataCase.caseTypes != null
                and dataCase.caseTypes.length > 0">
            and c.case_type in
            <foreach item="item" index="index" collection="dataCase.caseTypes" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="orderBy != null and orderBy != '' and sort != null and sort != ''">
            order by ${orderBy} ${sort}
        </if>

    </select>

    <select id="queryCaseSum" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        ISNULL(sum(t.m_val), 0) as [dataCase.mVal],
        ISNULL(sum(t.m_val*t.repay_money),0) as [dataCase.commissionMoney]
        from (
        select
        distinct c.id, c.m_val, c.commission_money,r.repay_money
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.id != null">
            and r.collect_user = #{dataCase.collectionUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.name != null">
            and c.province = #{dataCase.province.name}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.name != null">
            and c.city = #{dataCase.city.name}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.name != null">
            and c.county = #{dataCase.county.name}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_time >= #{dataCase.expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_time &lt;= #{dataCase.expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date &lt;= #{repayDateEnd}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.ids != null
                and dataCase.collectionArea.ids.length > 0">
            and c.collection_area in
            <foreach item="item" index="index" collection="dataCase.collectionArea.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.batchNos != null
                and dataCase.batchNos.length > 0">
            and c.batch_no in
            <foreach item="item" index="index" collection="dataCase.batchNos" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.clients != null
                and dataCase.clients.length > 0">
            and c.client in
            <foreach item="item" index="index" collection="dataCase.clients" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.ids != null
                and dataCase.collectionUser.ids.length > 0">
            and r.collect_user in
            <foreach item="item" index="index" collection="dataCase.collectionUser.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.statuss != null
                and dataCase.statuss.length > 0">
            and c.status in
            <foreach item="item" index="index" collection="dataCase.statuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.accountAges != null
                and dataCase.accountAges.length > 0">
            and c.account_age in
            <foreach item="item" index="index" collection="dataCase.accountAges" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectStatuss != null
                and dataCase.collectStatuss.length > 0">
            and c.collect_status in
            <foreach item="item" index="index" collection="dataCase.collectStatuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>


        <if test="dataCase != null and dataCase.caseTypes != null
                and dataCase.caseTypes.length > 0">
            and c.case_type in
            <foreach item="item" index="index" collection="dataCase.caseTypes" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        ) t
    </select>

    <select id="queryRepaySum" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        ISNULL(sum(r.repay_money), 0) as repayMoney
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.id != null">
            and r.collect_user = #{dataCase.collectionUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.name != null">
            and c.province = #{dataCase.province.name}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.name != null">
            and c.city = #{dataCase.city.name}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.name != null">
            and c.county = #{dataCase.county.name}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_time >= #{dataCase.expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_time &lt;= #{dataCase.expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date &lt;= #{repayDateEnd}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.ids != null
                and dataCase.collectionArea.ids.length > 0">
            and c.collection_area in
            <foreach item="item" index="index" collection="dataCase.collectionArea.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.batchNos != null
                and dataCase.batchNos.length > 0">
            and c.batch_no in
            <foreach item="item" index="index" collection="dataCase.batchNos" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.clients != null
                and dataCase.clients.length > 0">
            and c.client in
            <foreach item="item" index="index" collection="dataCase.clients" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.ids != null
                and dataCase.collectionUser.ids.length > 0">
            and r.collect_user in
            <foreach item="item" index="index" collection="dataCase.collectionUser.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.statuss != null
                and dataCase.statuss.length > 0">
            and c.status in
            <foreach item="item" index="index" collection="dataCase.statuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.accountAges != null
                and dataCase.accountAges.length > 0">
            and c.account_age in
            <foreach item="item" index="index" collection="dataCase.accountAges" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectStatuss != null
                and dataCase.collectStatuss.length > 0">
            and c.collect_status in
            <foreach item="item" index="index" collection="dataCase.collectStatuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>


        <if test="dataCase != null and dataCase.caseTypes != null
                and dataCase.caseTypes.length > 0">
            and c.case_type in
            <foreach item="item" index="index" collection="dataCase.caseTypes" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="listRepayRecord" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        <include refid="colSql"/>
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="collectUser != null and collectUser.id != null">
            and r.collec_user = #{collectUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.name != null">
            and c.province = #{dataCase.province.name}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.name != null">
            and c.city = #{dataCase.city.name}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.name != null">
            and c.county = #{dataCase.county.name}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_time >= #{dataCase.expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_time &lt;= #{dataCase.expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date >= #{repayDateEnd}
        </if>
        <if test="ids != null and ids.length >0">
            and r.id in
            <foreach collection="ids" item="item" open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.ids != null
                and dataCase.collectionArea.ids.length > 0">
            and c.collection_area in
            <foreach item="item" index="index" collection="dataCase.collectionArea.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.batchNos != null
                and dataCase.batchNos.length > 0">
            and c.batch_no in
            <foreach item="item" index="index" collection="dataCase.batchNos" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.clients != null
                and dataCase.clients.length > 0">
            and c.client in
            <foreach item="item" index="index" collection="dataCase.clients" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.ids != null
                and dataCase.collectionUser.ids.length > 0">
            and r.collect_user in
            <foreach item="item" index="index" collection="dataCase.collectionUser.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.statuss != null
                and dataCase.statuss.length > 0">
            and c.status in
            <foreach item="item" index="index" collection="dataCase.statuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.accountAges != null
                and dataCase.accountAges.length > 0">
            and c.account_age in
            <foreach item="item" index="index" collection="dataCase.accountAges" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectStatuss != null
                and dataCase.collectStatuss.length > 0">
            and c.collect_status in
            <foreach item="item" index="index" collection="dataCase.collectStatuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>


        <if test="dataCase != null and dataCase.caseTypes != null
                and dataCase.caseTypes.length > 0">
            and c.case_type in
            <foreach item="item" index="index" collection="dataCase.caseTypes" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>


    <select id="listRepayRecordSelectExport" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        <foreach collection ="exportKeyList" item="reddemCode" index= "index" separator =",">
            ${reddemCode}
        </foreach >
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="collectUser != null and collectUser.id != null">
            and r.collec_user = #{collectUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.name != null">
            and c.province = #{dataCase.province.name}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.name != null">
            and c.city = #{dataCase.city.name}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.name != null">
            and c.county = #{dataCase.county.name}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_time >= #{dataCase.expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_time &lt;= #{dataCase.expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date >= #{repayDateEnd}
        </if>
        <if test="ids != null and ids.length >0">
            and r.id in
            <foreach collection="ids" item="item" separator ="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.ids != null
                and dataCase.collectionArea.ids.length > 0">
            and c.collection_area in
            <foreach item="item" index="index" collection="dataCase.collectionArea.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.batchNos != null
                and dataCase.batchNos.length > 0">
            and c.batch_no in
            <foreach item="item" index="index" collection="dataCase.batchNos" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.clients != null
                and dataCase.clients.length > 0">
            and c.client in
            <foreach item="item" index="index" collection="dataCase.clients" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.ids != null
                and dataCase.collectionUser.ids.length > 0">
            and r.collect_user in
            <foreach item="item" index="index" collection="dataCase.collectionUser.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.statuss != null
                and dataCase.statuss.length > 0">
            and c.status in
            <foreach item="item" index="index" collection="dataCase.statuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.accountAges != null
                and dataCase.accountAges.length > 0">
            and c.account_age in
            <foreach item="item" index="index" collection="dataCase.accountAges" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectStatuss != null
                and dataCase.collectStatuss.length > 0">
            and c.collect_status in
            <foreach item="item" index="index" collection="dataCase.collectStatuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>


        <if test="dataCase != null and dataCase.caseTypes != null
                and dataCase.caseTypes.length > 0">
            and c.case_type in
            <foreach item="item" index="index" collection="dataCase.caseTypes" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="listRepayRecordExport" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        <foreach collection ="exportKeyList" item="reddemCode" index= "index" separator =",">
            ${reddemCode}
        </foreach >
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="collectUser != null and collectUser.id != null">
            and r.collec_user = #{collectUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.name != null">
            and c.province = #{dataCase.province.name}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.name != null">
            and c.city = #{dataCase.city.name}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.name != null">
            and c.county = #{dataCase.county.name}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_time >= #{dataCase.expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_time &lt;= #{dataCase.expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" item="item" open="(" close=")" separator=",">
                '${item}'
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" item="item" open="(" close=")" separator=",">
                ${item}
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date >= #{repayDateEnd}
        </if>
        <if test="ids != null and ids.length >0">
            and r.id in
            <foreach collection="ids" item="item" open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.ids != null
                and dataCase.collectionArea.ids.length > 0">
            and c.collection_area in
            <foreach item="item" index="index" collection="dataCase.collectionArea.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.batchNos != null
                and dataCase.batchNos.length > 0">
            and c.batch_no in
            <foreach item="item" index="index" collection="dataCase.batchNos" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.clients != null
                and dataCase.clients.length > 0">
            and c.client in
            <foreach item="item" index="index" collection="dataCase.clients" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectionUser != null and dataCase.collectionUser.ids != null
                and dataCase.collectionUser.ids.length > 0">
            and r.collect_user in
            <foreach item="item" index="index" collection="dataCase.collectionUser.ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.statuss != null
                and dataCase.statuss.length > 0">
            and c.status in
            <foreach item="item" index="index" collection="dataCase.statuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.accountAges != null
                and dataCase.accountAges.length > 0">
            and c.account_age in
            <foreach item="item" index="index" collection="dataCase.accountAges" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="dataCase != null and dataCase.collectStatuss != null
                and dataCase.collectStatuss.length > 0">
            and c.collect_status in
            <foreach item="item" index="index" collection="dataCase.collectStatuss" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>


        <if test="dataCase != null and dataCase.caseTypes != null
                and dataCase.caseTypes.length > 0">
            and c.case_type in
            <foreach item="item" index="index" collection="dataCase.caseTypes" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <update id="updateRecordStatus" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        update data_case_repay_record
        set record_status = #{recordStatus}
        where delete_flag = 0
        and id in
        <foreach collection="ids" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>

    <insert id="save" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        insert into data_case_repay_record
        (
            data_case,
            collect_user,
            confirm_user,
            confirm_time,
            repay_date,
            repay_money,
            repay_user,
            repay_type,
            remark,
            record_status,
            delete_flag,
            create_user,
            update_user,
            create_time
        )
        VALUES
        (
            #{dataCase.id},
            #{collectUser.id},
            #{confirmUser.id},
            GETDATE(),
            convert(datetime,#{repayDate}, 20),
            #{repayMoney},
            #{repayUser},
            #{repayType.id},
            #{remark},
            '0',
            0,
            #{createUser.id},
            #{updateUser.id},
            GETDATE()
        )
    </insert>

    <insert id="addList" parameterType="java.util.List">
        insert into data_case_repay_record
        (
        data_case,
        collect_user,
        confirm_user,
        confirm_time,
        repay_date,
        repay_money,
        repay_user,
        repay_type,
        settle_flag,
        remark,
        record_status,
        create_user,
        update_user,
        delete_flag,
        create_time
        )
        values
        <foreach collection="list" separator="," item="item">
            (
            #{item.dataCase.id},
            #{item.collectUser.id},
            #{item.confirmUser.id},
            GETDATE(),
            #{item.repayDate},
            #{item.repayMoney},
             #{item.repayUser},
             #{item.repayType.id},
             #{item.settleFlag},
             #{item.remark},
            0,
             #{item.createUser.id},
             #{item.updateUser.id},
            0,
            GETDATE()
             )
         </foreach>
     </insert>

     <select id="listBySeqNo" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
         select
         id as id,
         settle_flag as [settleFlag],
         repay_money as [repayMoney]
         from data_case_repay_record
         where data_case = #{dataCase.id}
         and record_status = 0
         and delete_flag = 0
     </select>

    <select id="listByCaseId" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        id as id,repay_money as repayMoney,repay_user as repayUser,repay_type as [repayType.id],repay_date as repayDate,confirm_time as confirmTime,confirm_user as  [confirmUser.id],remark
        from data_case_repay_record
        where data_case = #{dataCase.id}
        and delete_flag = 0
    </select>

     <select id="findById" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
         select
             id as id, collect_user as [collectUser.id],
             data_case as [dataCase.id]
         from data_case_repay_record
         where id = #{id}
         and delete_flag = 0
     </select>

    <select id="showRepay" parameterType="xyz.zaijushou.zhx.sys.entity.OdvPercentage" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        t2.seq_no as [dataCase.seqNo],t1.repay_money as repayMoney,t1.repay_date as repayDate
        from data_case_repay_record t1
        left join data_case t2 on t1.data_case =t2.id
        where t2.business_type = #{line}
        and t1.collect_user = #{odv}
        and t1.repay_date  &gt;= #{starttime} and t1.repay_date &lt; = #{endtime}
    </select>

    <select id="getRepayByCollectUser" parameterType="java.util.Map" resultType="java.math.BigDecimal">
        select
        ISNULL(sum(r.repay_money), 0) as repayMoney
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="collectUser != null and collectUser != '' ">
            and r.collect_user = #{collectUser}
        </if>
        <if test="dataCase != null and collectUser != '' ">
            and r.data_case = #{dataCase}
        </if>
    </select>
 </mapper>