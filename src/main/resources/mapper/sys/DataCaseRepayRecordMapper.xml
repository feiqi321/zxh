<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xyz.zaijushou.zhx.sys.dao.DataCaseRepayRecordMapper">

    <sql id="colSql">
        r.id as id,
        r.data_case as 'dataCase.id',
        c.collect_status as 'dataCase.collectStatus',
        c.batch_no as 'dataCase.batchNo',
        c.client as 'dataCase.client',
        c.seq_no as 'dataCase.seqNo',
        c.ident_no as 'dataCase.identNo',
        c.card_no as 'dataCase.cardNo',
        c.card_type as 'dataCase.cardType',
        c.account as 'dataCase.account',
        c.currency_type as 'dataCase.currencyType',
        c.archive_no as 'dataCase.archiveNo',
        c.name as 'dataCase.name',
        c.money as 'dataCase.money',
        c.en_repay_amt as 'dataCase.enRepayAmt',
        c.principle as 'dataCase.principle',
        c.last_repay_date as 'dataCase.lastRepayDate',
        c.case_date as 'dataCase.caseDate',
        c.collection_user as 'dataCase.collectionUser.id',
        c.credit_line as 'dataCase.creditLine',
        c.home_address as 'dataCase.homeAddress',
        c.home_tel_number as 'dataCase.homeTelNumber',
        c.unit_name as 'dataCase.unitName',
        c.unit_address as 'dataCase.unitAddress',
        c.tel as 'dataCase.tel',
        c.unit_tel_number as 'dataCase.unitTelNumber',
        r.collect_user as 'collectUser.id',
        r.repay_date as repayDate,
        r.repay_money as repayMoney,
        r.repay_user as repayUser,
        r.repay_type as repayType,
        r.confirm_user as 'confirmUser.id',
        r.confirm_time as confirmTime,
        r.record_status as recordStatus,
        r.remark as remark,
        r.create_user as 'createUser.id',
        r.update_user as 'updateUser.id',
        r.create_time as createTime,
        r.update_time as updateTime,
        r.delete_flag as deleteFlag
    </sql>

    <select id="pageRepayRecordList" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity" resultType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        select
        <include refid="colSql"/>
        from data_case_repay_record r
        left join data_case c on r.data_case = c.id
        where r.delete_flag = 0
        <if test="recordStatus != null and recordStatus != ''">
            and r.record_status = #{recordStatus}
        </if>
        <if test="dataCase != null and dataCase.collectionArea != null and dataCase.collectionArea.id != null">
            and c.collection_area = #{dataCase.collectionArea.id}
        </if>
        <if test="dataCase != null and dataCase.client != null and dataCase.client != ''">
            and c.client = #{dataCase.client}
        </if>
        <if test="dataCase != null and dataCase.batchNo != null and dataCase.batchNo != ''">
            and c.batch_no = #{dataCase.batchNo}
        </if>
        <!--todo 回收部门 -->
        <if test="collectUser != null and collectUser.id != null">
            and r.collec_user = #{collectUser.id}
        </if>
        <if test="dataCase != null and dataCase.name != null and dataCase.name != ''">
            and c.name = #{dataCase.name}
        </if>
        <if test="dataCase != null and dataCase.province != null and dataCase.province.id != null">
            and c.province = #{dataCase.province.id}
        </if>
        <if test="dataCase != null and dataCase.city != null and dataCase.city.id != null">
            and c.city = #{dataCase.city.id}
        </if>
        <if test="dataCase != null and dataCase.county != null and dataCase.county.id != null">
            and c.county = #{dataCase.county.id}
        </if>
        <if test="dataCase != null and dataCase.status != null">
            and c.status = #{dataCase.status}
        </if>
        <if test="dataCase != null and dataCase.overdueBillTime != null">
            and c.overdue_bill_time = #{dataCase.overdueBillTime}
        </if>
        <if test="dataCase != null and dataCase.collectStatus != 0">
            and c.collect_status = #{dataCase.collectStatus}
        </if>
        <if test="dataCase != null and dataCase.caseDateStart != null">
            and c.case_date >= #{dataCase.caseDateStart}
        </if>
        <if test="dataCase != null and dataCase.caseDateEnd != null">
            and c.case_date &lt;= #{dataCase.caseDateEnd}
        </if>
        <if test="dataCase != null and dataCase.expectStartTime != null">
            and c.expect_start_time >= #{expectStartTime}
        </if>
        <if test="dataCase != null and dataCase.expectEndTime != null">
            and c.expect_start_time &lt;= #{expectEndTime}
        </if>
        <if test="dataCase != null and dataCase.caseType != null">
            and c.case_type = #{dataCase.caseType}
        </if>
        <if test="dataCase != null and dataCase.seqNos != null and dataCase.seqNos.length > 0">
            and c.seq_no in
            <foreach collection="dataCase.seqNos" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.identNos != null and dataCase.identNos.length > 0">
            and c.ident_no in
            <foreach collection="dataCase.identNos" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.accounts != null and dataCase.accounts.length > 0">
            and c.account in
            <foreach collection="dataCase.accounts" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="dataCase != null and dataCase.cardNos != null and dataCase.cardNos.length > 0">
            and c.card_no in
            <foreach collection="dataCase.cardNos" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="confirmUser != null and confirmUser.id != null">
            and r.confirm_user = #{confirmUser.id}
        </if>
        <if test="confirmTimeStart != null">
            and r.confirm_time >= #{confirmTimeStart}
        </if>
        <if test="confirmTimeEnd != null">
            and r.confirm_time >= #{confirmTimeEnd}
        </if>
        <if test="repayDateStart != null">
            and r.repay_date >= #{repayDateStart}
        </if>
        <if test="repayDateEnd != null">
            and r.repay_date >= #{repayDateEnd}
        </if>
    </select>

    <update id="updateRecordStatus" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        update data_case_repay_record
        set record_status = #{recordStatus}
        where delete_flag = 0
        and id in
        <foreach collection="ids" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>

    <insert id="save" parameterType="xyz.zaijushou.zhx.sys.entity.DataCaseRepayRecordEntity">
        insert into data_case_repay_record
        (
            data_case,
            collect_user,
            repay_date,
            repay_money,
            repay_user,
            repay_type,
            remark,
            create_user,
            update_user
        )
        value
        (
            #{dataCase.id},
            #{collectUser.id},
            #{repayDate},
            #{repayMoney},
            #{repayUser},
            #{repayType},
            #{remark},
            #{createUser.id},
            #{updateUser.id}
        )
    </insert>

</mapper>